<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIAIT SVG Viewer</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f0f0;
            height: 100vh; /* Full viewport height */
            overflow: hidden; /* Prevent body scroll, SVG container will scroll */
        }
        .controls {
            padding: 15px;
            background-color: #fff;
            border-bottom: 1px solid #ddd;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            z-index: 100; /* Ensure controls are above fullscreen SVG */
        }
        /* Styling for the custom file input button */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            background-color: #007bff; /* Blue */
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            border: none;
            text-align: center;
            line-height: normal; /* For consistent button height */
        }
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0; /* Hide the default file input button */
            cursor: pointer;
            width: 100%;
            height: 100%;
        }
        .action-button {
            background-color: #28a745; /* Green */
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            border: none;
            line-height: normal;
        }
        .action-button:hover, .file-input-wrapper:hover {
            opacity: 0.9;
        }

        #svg-container {
            flex-grow: 1; /* Takes all available vertical space */
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Hide scrollbars, SVG should fit */
            background-color: #fff;
            position: relative; /* Base for fullscreen positioning */
            transition: all 0.3s ease; /* Smooth transition for fullscreen toggle */
            box-sizing: border-box; /* Include padding/border in element's total width/height */
            padding: 10px; /* Some padding around the SVG */
        }
        #svg-container svg {
            /* We are no longer forcing 100% width/height here.
               The SVG's intrinsic width/height attributes will be honored,
               and max-width/height will scale it down if needed. */
            max-width: 100%;
            max-height: 100%;
            display: block; 
            /* Transition for smooth SVG attribute transform */
            transition: transform 0.3s ease; 
            object-fit: contain; /* Ensure SVG is scaled to fit within its bounds if its aspect ratio differs from container */
        }
        #svg-container p {
            color: #888;
            font-style: italic;
            text-align: center;
        }

        /* Fullscreen mode for SVG container */
        #svg-container.fullscreen {
            position: fixed; /* Fixed position relative to viewport */
            top: 0;
            left: 0;
            width: 100vw; /* Full viewport width */
            height: 100vh; /* Full viewport height */
            background-color: rgba(0,0,0,0.95); /* Darker, slightly transparent background */
            z-index: 999; /* Ensure it's on top of everything else */
            padding: 0;
            margin: 0;
            overflow: hidden; /* Hide scrollbars in fullscreen */
        }
        #svg-container.fullscreen svg {
            /* In fullscreen, SVG also needs to scale to the viewport dimensions correctly when rotated */
            max-width: 100vw;
            max-height: 100vh;
            width: auto; /* Allow intrinsic width/height to be respected, scaled by max-width/height */
            height: auto; /* Allow intrinsic width/height to be respected, scaled by max-width/height */
            margin: auto;
            object-fit: contain; /* Essential for correct scaling with rotation */
        }
    </style>
</head>
<body>
    <div class="controls">
        <label class="file-input-wrapper">
            Open SVG File
            <input type="file" id="svgFileInput" accept=".svg">
        </label>
        <button id="toggleViewButton" class="action-button" style="display: none;">Toggle Full View</button>
    </div>

    <div id="svg-container">
        <img src="chart_after.svg" alt="Please open an SVG file to view it here.">
    </div>

    <script>
        const svgFileInput = document.getElementById('svgFileInput');
        const svgContainer = document.getElementById('svg-container');
        const toggleViewButton = document.getElementById('toggleViewButton');
        const messageElement = document.getElementById('message');

        let svgLoaded = false; // To track if an SVG is currently displayed

        // Function to apply rotation by manipulating the SVG DOM's transform attribute
        function applyDeviceRotation() {
            const svgElement = svgContainer.querySelector('svg');
            if (svgElement && svgLoaded) {
                // Determine rotation degree based on device orientation
                let rotationDegree = 0;
                if (screen.orientation && screen.orientation.angle !== undefined) {
                    rotationDegree = screen.orientation.angle;
                } else if (window.orientation !== undefined) {
                    // Fallback for older browsers: window.orientation gives 0, 90, -90, 180
                    if (window.orientation === 90) rotationDegree = 90;
                    else if (window.orientation === -90) rotationDegree = 270; 
                    else if (window.orientation === 180) rotationDegree = 180;
                }
                
                // Get viewBox dimensions to calculate the rotation origin (center of the SVG content)
                // If viewBox is not present, or if width/height are used without viewBox, this gets tricky.
                // We'll try to use viewBox first, then fallback to getBBox() if available.
                let cx = 0, cy = 0; 
                let hasViewBox = false;

                const viewBoxAttr = svgElement.getAttribute('viewBox');
                if (viewBoxAttr) {
                    const parts = viewBoxAttr.split(' ').map(Number);
                    if (parts.length === 4) {
                        const vbMinX = parts[0];
                        const vbMinY = parts[1];
                        const vbWidth = parts[2];
                        const vbHeight = parts[3];
                        cx = vbMinX + (vbWidth / 2);
                        cy = vbMinY + (vbHeight / 2);
                        hasViewBox = true;
                        console.log(`[VIAIT] ViewBox detected: ${viewBoxAttr}. Calculated center: (${cx}, ${cy})`);
                    } else {
                        console.warn('[VIAIT] Invalid viewBox format:', viewBoxAttr);
                    }
                } 
                
                // Fallback if no viewBox or malformed, try to use getBBox() for content bounds
                if (!hasViewBox && typeof svgElement.getBBox === 'function') {
                    try {
                        const bbox = svgElement.getBBox();
                        cx = bbox.x + bbox.width / 2;
                        cy = bbox.y + bbox.height / 2;
                        console.log(`[VIAIT] No valid viewBox, using getBBox() for center: (${cx}, ${cy})`);
                    } catch (e) {
                        console.error('[VIAIT] getBBox() failed, defaulting origin to 0,0:', e);
                        cx = 0; cy = 0; // Default if getBBox fails
                    }
                } else if (!hasViewBox) {
                    console.warn('[VIAIT] SVG has no viewBox and getBBox() is not available. Rotation origin defaulting to 0,0. SVG content might not rotate around its visual center.');
                }

                cx = 0;
                cy = 0;
                // SVG transform syntax for rotation around a point: rotate(angle cx cy)
                const svgTransform = `rotate(${rotationDegree} ${cx} ${cy})`;
                
                // Apply the transform attribute directly to the root SVG element
                svgElement.setAttribute('transform', svgTransform);
                console.log(`[VIAIT] Injected SVG transform attribute: "${svgTransform}". Detected angle: ${rotationDegree}deg.`); 
            } else {
                console.log('[VIAIT] SVG not loaded or element not found for SVG DOM transformation. Skipping.');
            }
        }

        svgFileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) {
                messageElement.style.display = 'block';
                messageElement.textContent = 'Please select an SVG file.';
                svgContainer.innerHTML = '';
                toggleViewButton.style.display = 'none';
                svgLoaded = false;
                console.log('[VIAIT] No file selected.'); 
                return;
            }

            if (file.type !== 'image/svg+xml') {
                messageElement.style.display = 'block';
                messageElement.textContent = 'Invalid file type. Please select a valid SVG file (.svg).';
                svgContainer.innerHTML = ''; 
                toggleViewButton.style.display = 'none';
                svgLoaded = false;
                console.log('[VIAIT] Invalid file type:', file.type); 
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const svgString = e.target.result;
                const parser = new DOMParser();
                const doc = parser.parseFromString(svgString, 'image/svg+xml');
                const svgElement = doc.documentElement; // This is the root <svg> element

                if (!svgElement || svgElement.tagName.toLowerCase() !== 'svg') {
                    messageElement.style.display = 'block';
                    messageElement.textContent = 'Invalid SVG content after parsing.';
                    svgContainer.innerHTML = '';
                    toggleViewButton.style.display = 'none';
                    svgLoaded = false;
                    console.error('[VIAIT] Parsed content is not a valid SVG element.');
                    return;
                }

                // Append the parsed SVG DOM element directly
                svgContainer.innerHTML = ''; 
                svgContainer.appendChild(svgElement);

                messageElement.style.display = 'none';
                toggleViewButton.style.display = 'inline-block';
                svgLoaded = true;
                
                // Apply initial rotation after a small delay to ensure DOM is ready
                setTimeout(() => {
                    applyDeviceRotation(); 
                    console.log('[VIAIT] SVG loaded and initial DOM rotation applied after delay.'); 
                }, 100); 
            };
            reader.onerror = function() {
                messageElement.style.display = 'block';
                messageElement.textContent = 'Failed to read file. Please try again.';
                svgContainer.innerHTML = '';
                toggleViewButton.style.display = 'none';
                svgLoaded = false;
                console.error('[VIAIT] Failed to read file:', reader.error); 
            };
            reader.readAsText(file);
        });

        toggleViewButton.addEventListener('click', function() {
            svgContainer.classList.toggle('fullscreen');
            if (svgContainer.classList.contains('fullscreen')) {
                toggleViewButton.textContent = 'Exit Full View';
            } else {
                toggleViewButton.textContent = 'Toggle Full View';
            }
            // Reapply rotation with a slight delay after view toggle
            setTimeout(applyDeviceRotation, 100); 
            console.log('[VIAIT] Toggle Full View clicked. DOM rotation reapplied with delay.'); 
        });

        // Listen for orientation changes using the standard Screen Orientation API if available
        if (screen.orientation) {
            screen.orientation.addEventListener('change', applyDeviceRotation);
            console.log('[VIAIT] Listening to screen.orientation.change'); 
        } else {
            // Fallback for older browsers or if screen.orientation is not supported
            window.addEventListener('orientationchange', applyDeviceRotation);
            console.log('[VIAIT] Listening to window.orientationchange (fallback)'); 
        }
        window.addEventListener('resize', applyDeviceRotation); // Also listen for resize
        console.log('[VIAIT] Listening to resize event.'); 

        // Initial application of rotation when the page loads, with a slight delay
        window.addEventListener('load', () => {
            setTimeout(applyDeviceRotation, 100);
            console.log('[VIAIT] Page loaded, attempting initial DOM rotation after delay.');
        });


        // Optional: Add drag-and-drop functionality for desktop convenience
        document.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        });

        document.addEventListener('drop', (e) => {
            e.preventDefault();
            if (e.dataTransfer.items) {
                for (let i = 0; i < e.dataTransfer.items.length; i++) {
                    if (e.dataTransfer.items[i].kind === 'file' && e.dataTransfer.items[i].type === 'image/svg+xml') {
                        const file = e.dataTransfer.items[i].getAsFile();
                        if (file) {
                            svgFileInput.files = e.dataTransfer.files;
                            svgFileInput.dispatchEvent(new Event('change', { bubbles: true }));
                            console.log('[VIAIT] File dropped and processed.'); 
                            break;
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>
